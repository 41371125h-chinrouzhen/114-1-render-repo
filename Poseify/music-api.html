<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Music API | Chin Rou Zhen</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-lg-5 fixed-top">
        <a href="index.html" class="navbar-brand ms-4 ms-lg-0">
            <h2 class="mb-0 text-primary text-uppercase">Rou Zhen</h2>
        </a>
        <div class="ms-auto">
            <a href="index.html" class="btn btn-outline-primary">Back to Home</a>
        </div>
    </nav>

    <div class="container py-5 page-padding-top">
        <div class="text-center mb-5">
            <h1 class="text-white">Music Search & Lyrics</h1>
            <p class="text-white-50">Powered by iTunes API & Lyrics.ovh</p>
        </div>

        <div class="row justify-content-center mb-5">
            <div class="col-lg-8">
                <div class="input-group input-group-lg">
                    <input type="text" id="song-input" class="form-control" placeholder="Enter song name (e.g., Yellow Coldplay)..." onkeypress="handleEnter(event)">
                    <button class="btn btn-primary px-4" onclick="searchSong()">
                        <i class="fa fa-search me-2"></i> Search
                    </button>
                </div>
            </div>
        </div>

        <div id="result-area" class="row g-4 d-none">
            
            <div class="col-lg-4">
                <div class="card bg-secondary border-0 h-100 text-center p-4">
                    <div class="card-body d-flex flex-column align-items-center justify-content-center">
                        <img id="album-cover" src="" class="rounded mb-4" style="width: 250px; height: 250px; object-fit: cover;" alt="Album Art">
                        
                        <h3 id="track-name" class="text-white mb-1">Song Title</h3>
                        <h5 id="artist-name" class="text-primary mb-4">Artist Name</h5>
                        
                        <audio id="audio-preview" controls class="w-100 mb-3">
                            <source src="" type="audio/mpeg">
                            Your browser does not support audio element.
                        </audio>
                        
                        <p class="text-white-50 small"><i class="fa-brands fa-apple me-1"></i> Data from iTunes</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card bg-dark border-0 h-100 p-4">
                    <div class="card-header bg-transparent border-bottom border-secondary">
                        <h4 class="text-white mb-0"><i class="fa-solid fa-align-center me-2"></i>Lyrics</h4>
                    </div>
                    <div class="card-body">
                        <div id="lyrics-content" class="text-white-50 text-center">
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading-spinner" class="text-center d-none">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
            <p class="mt-3 text-white">Searching for music & lyrics...</p>
        </div>

    </div>

    <script>
        function handleEnter(e) {
            if (e.key === 'Enter') searchSong();
        }

        async function searchSong() {
            const query = document.getElementById('song-input').value.trim();
            if (!query) return;

            // UI 切換：顯示 Loading，隱藏結果
            document.getElementById('loading-spinner').classList.remove('d-none');
            document.getElementById('result-area').classList.add('d-none');
            document.getElementById('lyrics-content').innerText = "Loading lyrics...";

            try {
                // 1. 呼叫 iTunes API 抓取歌曲資訊
                const itunesRes = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&media=music&limit=1`);
                const itunesData = await itunesRes.json();

                if (itunesData.resultCount === 0) {
                    alert("Song not found on iTunes!");
                    document.getElementById('loading-spinner').classList.add('d-none');
                    return;
                }

                const song = itunesData.results[0];
                const artist = song.artistName;
                const title = song.trackName;

                // 更新左側資訊
                document.getElementById('album-cover').src = song.artworkUrl100.replace('100x100', '400x400'); // 拿高畫質圖
                document.getElementById('track-name').innerText = title;
                document.getElementById('artist-name').innerText = artist;
                
                // 更新播放器
                const audioPlayer = document.getElementById('audio-preview');
                audioPlayer.src = song.previewUrl;
                audioPlayer.load(); // 重置播放器

                // 2. 呼叫 Lyrics.ovh API 抓取歌詞
                // 注意：這是一個免費 API，準確率約 70%，有些新歌可能找不到
                try {
                    const lyricsRes = await fetch(`https://api.lyrics.ovh/v1/${encodeURIComponent(artist)}/${encodeURIComponent(title)}`);
                    const lyricsData = await lyricsRes.json();

                    if (lyricsData.lyrics) {
                        document.getElementById('lyrics-content').innerText = lyricsData.lyrics;
                    } else {
                        document.getElementById('lyrics-content').innerHTML = "<i class='fa-regular fa-face-sad-tear display-4 mb-3 d-block'></i>Lyrics not found in the free database.<br>(Enjoy the music preview instead!)";
                    }
                } catch (err) {
                    document.getElementById('lyrics-content').innerHTML = "Lyrics service unavailable.";
                }

                // 顯示結果
                document.getElementById('loading-spinner').classList.add('d-none');
                document.getElementById('result-area').classList.remove('d-none');

            } catch (error) {
                console.error(error);
                alert("An error occurred while fetching data.");
                document.getElementById('loading-spinner').classList.add('d-none');
            }
        }
    </script>
</body>
</html>