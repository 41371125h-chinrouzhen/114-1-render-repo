/* js/ai-chat.js */

// ğŸ”¥ è«‹å°‡é€™è£¡æ›æˆä½  Render éƒ¨ç½²å¾Œå¾—åˆ°çš„ç¶²å€ + /api/chat
// ä¾‹å¦‚: "https://my-backend.onrender.com/api/chat"
// æ³¨æ„ï¼šä¸è¦åªè²¼ç¶²å€ï¼Œå¾Œé¢è¦åŠ  "/api/chat"
const BACKEND_URL = "https://ä½ çš„Renderç¶²å€.onrender.com/api/chat"; 

const chatContainer = document.getElementById('virtual-me-root');

function initChat() {
    chatContainer.innerHTML = `
        <div class="card border-0" style="height: 500px; display: flex; flex-direction: column;">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span><i class="fa-solid fa-robot me-2"></i>Virtual Rou Zhen</span>
                <span class="badge bg-light text-dark">Online</span>
            </div>
            <div id="chat-history" class="card-body bg-light" style="flex: 1; overflow-y: auto; padding: 20px;">
                <div class="d-flex flex-column align-items-start mb-3">
                    <div class="bg-white p-3 rounded shadow-sm text-dark" style="max-width: 80%;">
                        å“ˆå›‰ï¼æˆ‘æ˜¯æŸ”è“çš„ AI åˆ†èº«ã€‚æˆ‘ç¾åœ¨é€éé›²ç«¯ä¼ºæœå™¨é‹ä½œï¼Œæ›´å®‰å…¨ä¹Ÿæ›´è°æ˜å–”ï¼ä½ å¯ä»¥å•æˆ‘ä»»ä½•é—œæ–¼æˆ‘çš„å•é¡Œã€‚
                    </div>
                </div>
            </div>
            <div class="card-footer bg-white">
                <div class="input-group">
                    <input type="text" id="user-input" class="form-control border-0" placeholder="Type a message..." onkeypress="handleEnter(event)">
                    <button class="btn btn-primary" onclick="sendMessage()"><i class="fa fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    `;
}

function handleEnter(e) {
    if (e.key === 'Enter') sendMessage();
}

async function sendMessage() {
    const inputField = document.getElementById('user-input');
    const userText = inputField.value.trim();

    if (!userText) return;

    appendMessage('end', 'bg-primary text-white', userText);
    inputField.value = '';

    const loadingId = 'loading-' + Date.now();
    appendMessage('start', 'bg-white text-dark', '<i class="fa-solid fa-ellipsis fa-fade"></i> Thinking...', loadingId);

    try {
        // ğŸš€ ä¿®æ”¹é»ï¼šæ”¹ç‚ºç™¼é€è«‹æ±‚çµ¦ Render å¾Œç«¯
        const response = await fetch(BACKEND_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: userText })
        });

        const data = await response.json();
        
        document.getElementById(loadingId).remove();
        
        if (data.reply) {
            appendMessage('start', 'bg-white text-dark', data.reply);
        } else {
            appendMessage('start', 'bg-danger text-white', 'ä¼ºæœå™¨æ²’æœ‰å›æ‡‰ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        }

    } catch (error) {
        document.getElementById(loadingId).remove();
        // å¦‚æœ Render å…è²»ç‰ˆé€²å…¥ä¼‘çœ ï¼Œç¬¬ä¸€æ¬¡å–šé†’æœƒæ¯”è¼ƒä¹… (ç´„30ç§’-1åˆ†é˜)
        appendMessage('start', 'bg-warning text-dark', 'ä¼ºæœå™¨å–šé†’ä¸­æˆ–é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨ç­‰ç´„ 30 ç§’å¾Œå†è©¦ä¸€æ¬¡ï¼(Render å…è²»ç‰ˆé™åˆ¶)');
        console.error(error);
    }
}

function appendMessage(align, cssClass, text, id = null) {
    const history = document.getElementById('chat-history');
    const msgDiv = document.createElement('div');
    msgDiv.className = `d-flex flex-column align-items-${align} mb-3`;
    if (id) msgDiv.id = id;
    
    // ç°¡å–®è™•ç†æ›è¡Œ
    const formattedText = text.replace(/\n/g, '<br>');

    msgDiv.innerHTML = `
        <div class="${cssClass} p-3 rounded shadow-sm" style="max-width: 80%;">
            ${formattedText}
        </div>
    `;
    history.appendChild(msgDiv);
    history.scrollTop = history.scrollHeight;
}

document.addEventListener('DOMContentLoaded', initChat);